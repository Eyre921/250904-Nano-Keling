# Gemini API 500错误处理说明

## 问题描述

当前系统在调用Google Gemini API进行图像处理时，可能会遇到HTTP 500内部服务器错误。这是Google服务端的临时问题，不是我们系统的bug。

## 错误表现

- API返回HTTP 500状态码
- 错误信息："Internal error encountered"
- 系统会自动重试多次后仍然失败

## 已实施的改进措施

### 1. 增强的错误处理

- **更友好的错误信息**：将原来的"AI服务提供商服务器内部错误，请稍后再试"改为更详细的说明
- **新的错误信息**："处理失败: AI服务提供商服务器内部错误。这通常是临时问题，请等待几分钟后重试。如果问题持续存在，请联系技术支持。"

### 2. 优化的重试机制

- **增加重试次数**：从3次增加到4次
- **智能等待时间**：
  - 500错误：使用更长的等待时间（2秒、4秒、8秒、16秒、30秒）
  - 其他错误：标准指数退避（1秒、2秒、4秒、8秒、16秒）
- **最大等待时间限制**：500错误的单次等待时间不超过30秒

### 3. 详细的日志记录

- 记录每次重试的详细信息
- 包含响应状态码和响应内容
- 便于问题排查和监控

## 用户建议

### 遇到500错误时的处理步骤：

1. **等待重试**：系统会自动重试4次，总计等待时间约60秒
2. **稍后再试**：如果仍然失败，建议等待5-10分钟后重新尝试
3. **检查网络**：确认网络连接和代理设置正常
4. **联系支持**：如果问题持续超过30分钟，请联系技术支持

### 预防措施：

1. **避免高峰期**：尽量避开网络高峰时段使用
2. **分批处理**：对于大量图片，建议分批次处理
3. **备用方案**：考虑使用其他AI服务作为备选

## 技术细节

### 重试逻辑代码位置

- 文件：`backend/app/services.py`
- 函数：`call_ai_service_with_retry()`
- 错误处理：`handle_api_error()`

### 配置参数

```python
# 最大重试次数
max_retries = 4

# 500错误等待时间计算
wait_time = min((2 ** attempt) * 2, 30)

# 其他错误等待时间计算  
wait_time = (2 ** attempt)
```

## 监控和统计

系统会记录以下信息用于监控：

- API调用成功率
- 重试次数统计
- 错误类型分布
- 响应时间统计

## 更新日志

- **2025-09-04**：实施增强的500错误处理机制
- **2025-09-04**：增加重试次数和智能等待时间
- **2025-09-04**：优化错误信息提示

---

**注意**：Gemini API的500错误通常是Google服务端的临时问题，我们的系统已经实施了最佳的重试和错误处理策略。如果问题持续存在，建议联系Google Cloud支持或考虑使用备用AI服务。